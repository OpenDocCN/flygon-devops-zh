# 前言

欢迎来到具有 Swarm 的本地 Docker 集群！这是一本关于容器和分布式系统的书。我们将展示如何使用本地 Docker 工具来建模微服务，生成任务，扩展应用程序的规模，并将容器推送到 Docker 集群的极限！一句话，我们将讨论 Docker 编排。

随着 Swarm Mode 的最近崛起以及在 Docker Engine 内部启用 Swarm，事实证明编排 Docker 的最佳方式是……Docker！

不错，但是“编排 Docker”是什么意思？什么是编排？更好的是，什么是管弦乐队？

![前言](img/preface.jpg)

管弦乐队是由指挥家带领的音乐家组成的合奏团，指挥家指挥着节奏、节奏和声音的形状。弦乐、木管、打击乐、键盘和其他乐器都遵循指挥家的指导来演奏令人惊叹的交响乐，例如贝多芬的第九交响曲。

同样，在容器编排系统中，音乐家是任务，指挥是领导服务（Swarm 原语）。任务不仅仅演奏交响乐，或者至少不仅仅是：更抽象地说，它们执行一些计算工作，例如运行 Web 服务器。指挥家 Swarm 负责它们的配置、可用性、链接和扩展。这（以及更多）就是我们所说的“Docker 编排”。

本书展示了如何配置这样的 Docker“管弦乐队”，如何保证服务的可用性，如何连接任务以及如何扩展平台，以演奏您应用程序的交响乐。

# 本书涵盖内容

第一章，“欢迎来到 Docker Swarm”，介绍了 Swarm，并解释了为什么您需要一个容器的集群解决方案。它说明了 Swarm 的特性，并对其架构进行了高层次的描述。我们定义了一些用例，并描述了 Swarm 与 Fleet、Kubernetes 和 Mesos 的不同之处。本章介绍了 Docker 工具的安装，最后介绍了两个 Swarm 配置：本地 Swarm Standalone 和 DigitalOcean 上的远程 Swarm Mode 集群。

第二章，“发现发现服务”，是一个描述性和大部分抽象的章节。我们将学习发现机制和共识算法是什么，以及它们对分布式系统的重要性。我们将详细描述 Raft 及其实现 Etcd，这是 Swarm 模式中包含的共识机制。我们还将通过使用 Consul 扩展本地微小示例来展示第一章中使用的发现机制的局限性，并重新部署它。

第三章，“了解 Docker Swarm 模式”，讲述了允许创建任意大小任务集群的新 Docker 工具包。我们将介绍 Swarmit，Docker Swarm 模式的基础，展示它在 Docker 1.12+中的工作原理，讨论其架构、概念，以及它与“旧”Swarm 的不同之处，以及它如何通过抽象服务和任务来组织工作负载。

第四章，“创建生产级别的 Swarm”，展示并讨论了由社区驱动的项目 Swarm2k 和 Swarm3k，我们的 2300 和 4800 节点 Swarm 集群实验，其中运行了数十万个容器。我们演示了如何规划、配置这样庞大的集群，并总结了我们所学到的经验教训。

第五章，“管理 Swarm 集群”，是关于基础设施的一章。我们将展示如何增加或减少 Swarm 的大小，如何提升和降级节点，以及如何更新集群和节点属性。我们将介绍 Shipyard 和 Portainer.io 作为 Swarm 的图形用户界面。

第六章，“在 Swarm 上部署真实应用程序”，是我们将在 Swarm 上运行真实应用程序并在讨论中添加一些关于 Compose、Docker Stacks 和 Docker Application Bundles 的注释的地方。我们将展示典型的部署工作流程，如何在集群上过滤和调度容器，将它们作为服务启动，以任务的形式处理容器。我们将开始定义一个带有 Nginx 的 web 服务，然后部署一个必需的带有 MySQL 的 Wordpress 示例。最后，我们将继续使用一个更现实的应用程序：Apache Spark。

第七章，“扩展你的平台”，将从上一章开发新的主题。在这里，我们将介绍 Flocker，为 Spark on Swarm 增加存储容量，并展示如何在与 Swarm 结合的规模上自动安装和使用它。我们将通过运行一些真正的大数据作业和为这个基础设施设置一个基本的监控系统来完善我们的 Spark 示例。

第八章，“探索 Swarm 的其他功能”，讨论了一些对 Swarm 非常重要的高级主题，比如 Libnetwork 和 Libkv。

第九章，“保护 Swarm 集群和 Docker 软件供应链”，将重点讨论 Swarm 集群的安全考虑。其中包括证书、平台防火墙概念，以及对 Notary 的提及。

第十章，“Swarm 和云”，是一章介绍在云提供商上运行 Swarm 的最流行选项。我们将在 AWS 和 Azure 上安装 Swarm，然后介绍 Docker Datacenter，最后我们将转向 OpenStack，展示如何在 Magnum 的顶部安装和管理 Swarm，Magnum 是 OpenStack 的容器即服务解决方案。

第十一章，“接下来是什么？”，通过概述下一个 Docker 编排趋势，比如软件定义基础设施、Infrakit、unikernels、容器即服务，结束了讨论。冒险还在继续！

# 你需要为这本书做些什么

我们假设读者有一些使用 Docker 命令行的经验：在整本书中，我们将不断地拉取镜像、运行容器、定义服务、暴露端口和创建网络。

另外，理想的读者具有对网络协议的基本理解，并熟悉公共和私有云概念，比如虚拟机和租户网络。

为了跟随文本中的示例，你需要 Docker 及其工具。第一章，“欢迎来到 Docker Swarm”，涵盖了它们的安装。

另外，为了从示例中获得最大的收益，你需要访问一个公共（例如 AWS、Azure 或 DigitalOcean）或私有（例如 OpenStack）云来实例化虚拟机。

# 这本书适合谁

这本书是为 Docker 用户 - 开发人员和系统管理员 - 而写的，他们想要利用当前的 Swarm 和 Swarmkit 功能来扩展容器的大规模应用。

# 约定

在这本书中，您会发现许多文本样式，用于区分不同类型的信息。以下是一些样式的例子及其含义的解释。

文本中的代码词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 句柄显示如下："当执行 `docker swarm init` 时，只需复制粘贴输出的行"

一块代码设置如下：

```
digitalocean:
      image: “docker-1.12-rc4”
      region: nyc3
      ssh_key_fingerprint: “your SSH ID”
      ssh_user: root
```

任何命令行输入或输出都是这样写的：

```
      **# Set $GOPATH here
      go get https://github.com/chanwit/belt

```

**新术语**和**重要单词**以粗体显示。您在屏幕上看到的单词，例如菜单或对话框中的单词，会在文本中出现，如："UI 具有预期的选项，包括启动容器的模板列表，例如**MySQL**或**私有注册表**，但在撰写本文时尚不支持 Swarm 服务"

### 注意

警告或重要说明会出现在这样的框中。

### 提示

技巧和窍门是这样出现的。
