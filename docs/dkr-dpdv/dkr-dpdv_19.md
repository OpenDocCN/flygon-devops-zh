# 第十八章：企业级功能

本章是上一章的延续，涵盖了 Docker Universal Control Plane（UCP）和 Docker Trusted Registry（DTR）提供的一些企业级功能。

我们将假设您已经阅读了上一章，因此知道如何安装和配置它们，以及执行备份和恢复操作。

我们将把本章分为两部分：

+   简而言之

+   深入挖掘

### 企业级功能-简而言之

企业希望使用 Docker 和容器，但他们需要像真正的企业应用程序一样打包和支持。他们还需要像基于角色的访问控制和与 Active Directory 等企业目录服务的集成。这就是*Docker 企业版*发挥作用的地方。

Docker 企业版是 Docker 引擎的强化版本，具有运维 UI，安全注册表和一堆企业专注的功能。您可以在本地或云端部署它，自己管理它，并且可以获得支持合同。

总之，它是一个容器即服务平台，您可以在自己公司的数据中心安全运行。

### 企业级功能-深入挖掘

我们将把本章的主要部分分为以下几个部分：

+   基于角色的访问控制（RBAC）

+   Active Directory 集成

+   Docker 内容信任（DCT）

+   配置 Docker Trusted Registry（DTR）

+   使用 Docker Trusted Registry

+   镜像推广

+   HTTP 路由网格（HRM）

#### 基于角色的访问控制（RBAC）

在过去的 10 年中，我大部分时间都在金融服务行业从事 IT 工作。在我工作的大多数地方，角色基础访问控制（RBAC）和 Active Directory（AD）集成是强制性的两个复选框。如果你试图向我们销售一个产品，而它没有这两个功能，我们是不会购买的！

幸运的是，Docker EE 都有。在本节中，我们将讨论 RBAC。

UCP 通过一种称为*授予*的东西来实现 RBAC。在高层次上，授予由三个部分组成：

+   **主题**

+   **角色**

+   **集合**

*主题*是一个或多个用户或团队。*角色*是权限集，*集合*是这些权限适用的资源。见图 17.1。

![图 17.1 授予](img/figure17-1.png)

图 17.1 授予

图 17.2 显示了一个示例，其中`SRT`团队对`/zones/dev/srt`集合中的所有资源具有`container-full-control`访问权限。

![图 17.2](img/figure17-2.png)

图 17.2

让我们完成以下步骤来创建一个授予：

+   创建用户和团队

+   创建一个自定义角色

+   创建一个集合

+   创建一个授权

只有 UCP 管理员才能创建和管理用户、团队、角色、集合和授权。因此，为了跟随操作，你需要以 UCP 管理员身份登录。 

##### 创建用户和团队

将用户分组到团队，并将团队分配到授权是最佳实践。你*可以*将单个用户分配给*授权*，但这并不推荐。

让我们创建一些用户和团队。

1.  登录到 UCP。

1.  展开“用户管理”并点击“用户”。

从这里你可以创建用户。

1.  点击“组织和团队”。

从这里你可以创建组织。在接下来的几个步骤中，我们将使用一个名为“制造业”的组织作为示例。

1.  点击“制造业”组织并创建一个团队。

团队存在于组织中。不可能创建一个不属于任何组织的团队，一个团队只能是一个组织的成员。

1.  将用户添加到一个团队。

要将用户添加到团队，你需要点击进入团队，并从“操作”菜单中选择“添加用户”。

图 17.3 显示了如何将用户添加到“制造业”组织中的`SRT`团队。

![图 17.3 将用户添加到团队](img/figure17-3.png)

图 17.3 将用户添加到团队

现在你有了一些用户和团队。UCP 与 DTR 共享其用户数据库，这意味着你在 UCP 中创建的任何用户和团队也可以在 DTR 中使用。

##### 创建一个自定义角色

自定义角色非常强大，它们可以让你对分配的权限进行极其精细的控制。在这一步中，我们将创建一个名为`secret-ops`的新自定义角色，允许主体创建、删除、更新、使用和查看 Docker secrets。

1.  展开左侧导航窗格的“用户管理”选项卡，选择“角色”。

1.  创建一个新角色。

1.  给角色命名。

在这个例子中，我们将创建一个名为“secret-ops”的新自定义角色，具有执行所有与 secret 相关的操作的权限。

1.  选择“操作”并探索可以分配给角色的操作列表。

列表很长，允许你指定单个 API 操作。

1.  选择你想要分配给角色的单个 API 操作。

在这个例子中，我们将分配所有与 secret 相关的 API 操作。

![图 17.4 分配 API 操作给自定义角色](img/figure17-4.png)

图 17.4 分配 API 操作给自定义角色

1.  点击“创建”。

该角色现在已经在系统中，并可以分配给多个授权。

让我们创建一个集合。

##### 创建一个集合

在上一章中，我们了解到网络、卷、秘密、服务和节点都是 Swarm 资源——它们被存储在 Swarm 配置中的`/var/lib/docker/swarm`中。*集合*让你以符合组织结构和 IT 要求的方式对它们进行分组。例如，您的 IT 基础设施可能分为三个区域；`prod`、`test`和`dev`。如果是这种情况，您可以创建三个集合，并分配资源给每个集合，如图 17.5 所示。

![图 17.5 高级集合](img/figure17-5.png)

图 17.5 高级集合

每个资源只能属于一个集合。

在接下来的步骤中，我们将创建一个名为`zones/dev/srt`的新集合，并将一个秘密分配给它。集合本质上是分层的，因此您需要创建三个嵌套的集合，如下所示：`zones` > `dev` > `srt`。

从 Docker UCP web UI 执行以下所有步骤。

1.  从左侧导航窗格中选择`集合`，然后选择`创建集合`。

1.  创建名为`zones`的根集合。

1.  点击“查看子项”以查看`/zones`集合。

1.  创建一个名为`dev`的嵌套子集合。

1.  点击“查看子项”以查看`/zones/dev`集合。

1.  创建名为`srt`的最终嵌套子集合。

现在您有一个名为`/zones/dev/srt`的集合。但是，它目前是空的。在接下来的步骤中，我们将向其中添加一个*秘密*。

1.  创建一个新的秘密。

您可以从命令行或 UCP web UI 中创建它。我们将解释 web UI 方法。

从 UCP web UI 中点击：`秘密` > `创建秘密`。给它一个名称，一些数据，然后点击`保存`。

在创建秘密的同时也可以配置*集合*。但我们不是这样做的。

1.  在 UCP web UI 中找到并选择秘密。

1.  从“配置”下拉菜单中点击“集合”。

1.  通过“查看子项”层次结构导航，直到选择`/zones/dev/srt`集合，然后点击“保存”。

秘密现在是`/zones/dev/srt`集合的一部分。它不能是任何其他集合的成员。

在创建*授权*之前，还有一件关于*集合*的事情。集合具有继承模型，其中对任何集合的访问自动意味着对嵌套子集合的访问。在图 17.6 中，`dev`团队可以访问`/zones/dev`集合，因此它自动获得对`srt`、`hellcat`和`daemon`子集合中资源的访问权限。

![图 17.6 集合继承](img/figure17-6.png)

图 17.6 集合继承

###### 创建授予

现在您已经有了用户和团队、自定义角色和集合，您可以创建一个授予。在这个例子中，我们将为`srt-dev`团队创建一个授予，使其对`/zones/dev/srt`集合中的所有资源具有自定义`secret-ops`角色。

授予涉及*谁*，获得*什么访问权限*，对*哪些资源*。

![](img/figure17-7.png)

1.  展开左侧导航窗格上的“用户管理”选项卡，然后单击“授予”。

1.  创建一个新的授予。

1.  点击`Subject`，从`manufacturing`组织中选择`SRT`团队。

可以选择整个组织。如果这样做，组织内的所有团队都将包括在授予中。

1.  单击“角色”，然后选择自定义的`secret-ops`角色。

1.  单击“集合”，然后选择`/zones/dev/srt`集合。

在看到`/zones`之前，您可能需要查看顶级`Swarm`集合的子项。

1.  单击“保存”以创建授予。

现在已经创建了授予，并且可以在系统上的所有授予列表中查看。`manufacturing/SRT`团队的成员现在可以在`/zones/dev/srt`集合中执行所有与秘密相关的操作。

![](img/figure17-8.png)

您可以在授予处于活动状态时修改授予的组件。例如，您可以将用户添加到团队，将资源添加到集合。但是您不能更改分配给角色的 API 操作。如果您想要更改角色的权限，您需要创建一个具有所需权限的新角色。

###### 节点的 RBAC

最后关于 RBAC 的一件事。您可以将集群中的工作节点分组以进行调度。例如，您可能会为开发、测试和 QA 工作负载运行一个单一集群——一个单一集群可能会减少管理开销，并使将节点分配给三个不同环境变得更容易。但是您可能还希望将工作节点分成几部分，以便只有`dev`团队的成员可以将工作安排到`dev`集合中的节点等。

正如您所期望的那样，您可以通过*授予*来实现这一点。首先，您会将 UCP Worker 节点分配给一个自定义*集合*。然后，您会创建一个包括集合、内置的`Scheduler`*角色*和您想要分配授予的团队的授予。这样可以让您控制哪些用户可以将工作安排到集群中的哪些节点。

作为一个简单的例子，图 17.9 中显示的授权将允许`dev`团队的成员能够将服务和容器调度到`/zones/dev`集合中的工作节点上。

![图 17.9 节点的 RBAC](img/figure17-9.png)

图 17.9 节点的 RBAC

就是这样！您知道如何在 Docker UCP 中实现 RBAC 了！

#### Active Directory 集成

像所有优秀的企业工具一样，UCP 集成了 Active Directory 和其他 LDAP 目录服务。这使其能够利用来自您组织已建立的单一登录系统的现有用户和组。

在本节中进一步进行之前，非常重要的是与负责组织目录服务的团队讨论任何 AD/DLAP 集成计划。让他们从一开始就参与进来，这样您的规划和实施才能尽可能顺利！

开箱即用，UCP 用户和组数据存储在本地数据库中，DTR 利用该数据库实现单一登录（SSO）体验。这会在本地验证所有访问请求，并允许您登录到 DTR 而无需再次输入 UCP 凭据。但是，**UCP 管理员**可以配置 UCP 以利用存储在 AD 或其他 LDAP 目录服务中的现有企业用户帐户，将认证和帐户管理外包给现有团队和流程。

以下步骤将向您展示如何配置 UCP 以利用 AD 进行用户帐户。在高层次上，该过程告诉 UCP 在特定目录中搜索用户帐户，并将其复制到 UCP 中。如前所述，与您的目录服务团队协调此工作。

让我们开始吧。

1.  展开左侧导航窗格中的`Admin`下拉菜单，然后选择`Admin Settings`。

1.  选择`Authentication & Authorization`，并在**LDAP Enabled**标题下单击`Yes`。

1.  配置 LDAP 服务器设置。

在高层次上，您可以将`LDAP 服务器设置`视为*搜索位置*。例如，要在哪些目录中查找用户帐户。

在此处输入的值将特定于您的环境。

**LDAP 服务器 URL**是您将在其中搜索帐户的域中 LDAP 服务器的名称。例如，`ad.mycompany.internal`。

**Reader DN**和**Reader Password**是具有搜索权限的目录中帐户的凭据。该帐户必须存在于您正在搜索的目录中，或者受到该目录的信任。最佳做法是让它在目录中具有*只读*权限。

您可以使用“添加 LDAP 域+”按钮添加要搜索的其他域。每个域都需要自己的 LDAP 服务器 URL 和读取器帐户。

1.  配置 LDAP 用户搜索配置。

如果“LDAP 服务器设置”是*搜索位置*，那么“LDAP 用户搜索配置”就是*搜索对象*。

**基本 DN**指定从哪个 LDAP 节点开始搜索。

**用户名属性**是用作 UCP 用户名的 LDAP 属性。

**全名属性**是用作 UCP 帐户全名的 LDAP 属性。

请参阅其他更高级的设置的文档。在配置 LDAP 集成时，您还应该与目录服务团队进行咨询。

1.  一旦您配置了 LDAP 设置，UCP 将搜索匹配的用户并在 UCP 用户数据库中创建它们。然后，它将根据“同步间隔（小时）”设置执行定期同步操作。

如果您勾选了“即时用户配置”框，UCP 将推迟创建用户帐户，直到每个帐户的第一次登录事件。

1.  在点击“保存”之前，您应该始终在“LDAP 测试登录”部分执行测试登录。

测试登录需要使用 LDAP 系统中有效的用户帐户。测试将应用上面各节中定义的所有配置值（您即将保存的 LDAP 配置）。

只有在测试登录成功时才保存配置。

1.  保存配置。

此时，UCP 将搜索 LDAP 系统并创建与基本 DN 和其他提供的条件匹配的用户帐户。

在配置 LDAP 之前创建的本地用户帐户仍将存在于系统中，并且仍然可以使用。

#### Docker 内容信任（DCT）

在现代 IT 世界中，*信任*是一件大事！并且未来它将变得更加重要。幸运的是，Docker 通过一个名为 Docker 内容信任（DCT）的功能来实现信任。

在非常高的层次上，Docker 镜像的发布者可以在将其推送到存储库时对其进行签名。消费者随后可以在拉取它们时验证它们，或执行构建和运行操作。长话短说，DCT 使消费者能够保证他们得到了他们所要求的东西！

图 17.10 显示了高级架构。

![图 17.10 高级 DCT 架构](img/figure17-10.png)

图 17.10 高级 DCT 架构

DCT 实现*客户端*签名和验证操作，这意味着 Docker 客户端执行这些操作。

- 尽管在互联网上传输和推送软件时，加密保证非常重要，但在整个软件交付流程的每个层面和每个步骤中，它变得越来越重要。希望不久的将来，交付链的所有方面都将充满加密信任保证。

- 让我们快速示例配置 DCT 并看到它的运行情况。

- 您将需要一个单独的 Docker 客户端和一个可以将镜像推送到的仓库。Docker Hub 上的仓库将起作用。

- DCT 是通过 DOCKER_CONTENT_TRUST 环境变量打开和关闭的。将其设置为“1”将在当前会话中打开 DCT。将其设置为任何其他值将关闭它。以下示例将在基于 Linux 的 Docker 主机上打开它。

[PRE0]

- 未来的 docker push 命令将自动在推送操作中签署镜像。同样，只有签署的镜像才能使用 pull、build 和 run 命令。

- 让我们将一个带有新标记的镜像推送到一个仓库。

- 被推送的镜像可以是任何镜像。实际上，我正在使用的是我刚刚拉取的当前 alpine:latest。目前，它还没有由我签名！

1.  - 给镜像打标记，这样它就可以推送到您想要的仓库。我将把它推送到我个人 Docker Hub 帐户命名空间内的一个新仓库。

[PRE1]

- 登录到 Docker Hub（或其他注册表），这样您就可以在下一步中推送镜像。

[PRE2]

- 推送新标记的镜像。

- [PRE3]``

[PRE4]

- docker image pull nigelpoulton/dockerbook:unsigned

- 错误：docker.io/nigelpoulton/dockerbook 的信任数据不存在：

- notary.docker.io 没有 docker.io/nigelpoulton/dockerbook 的信任数据

[PRE5]

- docker image pull --disable-content-trust nigelpoulton/dockerbook:unsigned

[PRE6]

- docker 容器运行-d --rm nigelpoulton/dockerbook:unsigned

- docker：未签名的没有信任数据。

[PRE7]

- docker pull alpine:latest

- 最新：正在从库/alpine 拉取

- ff3a5c916c92：拉取完成

- 摘要：sha256:7df6...b1c0

- 状态：已下载更新的镜像 alpine:latest

[PRE8]

- docker image tag alpine:latest dtr.mydns.com/technology/test:v1

[PRE9]

- 执行“$（<env.sh）”。

[PRE10]

- docker login dtr.mydns.com

- 用户名：nigelpoulton

- 密码：

- 登录成功

[PRE11]

- docker image push dtr.mydns.com/technology/test:v1

- 推送是指一个仓库`[dtr.mydns.com/technology/test]`

- cd7100a72410：已推送

- v1：摘要：sha256:8c03...acbc 大小：528

- [PRE12][PRE13]
